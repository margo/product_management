name: Enforce Issue Creation Policy

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  check-issue-creator:
    runs-on: ubuntu-latest
    steps:
      - name: Check if user is in Product Management team
        id: check_team
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const creator = issue.user.login;
            const org = context.payload.organization.login;
            const pmTeamSlug = 'product-management';
            
            try {
              const { data: membership } = await github.rest.teams.getMembershipForUserInOrg({
                org: org,
                team_slug: pmTeamSlug,
                username: creator
              });
              console.log(`User ${creator} is in Product Management team - allowing issue`);
              return 'allowed';
            } catch (error) {
              if (error.status === 404) {
                console.log(`User ${creator} is NOT in Product Management team - closing issue`);
                return 'denied';
              }
              throw error;
            }

      - name: Close unauthorized issue
        if: steps.check_team.outputs.result == 'denied'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['unauthorized-creation', 'policy-violation']
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: '## ⚠️ Unauthorized Issue Creation\n\nHello @' + issue.user.login + ',\n\nThank you for your interest in contributing to this project. However, this issue has been automatically closed because it was created by someone who is not authorized to create new issues in this repository.\n\n### Repository Policy\n\nAccording to our contribution guidelines:\n- **Product Management Team**: Authorized to create and manage issues\n- **Technical Working Group (Technical-WG) Members**: Authorized to comment on existing issues only\n\n### What You Can Do\n\nIf you have feedback, concerns, or suggestions:\n1. **Find a related existing issue** and add your comments there\n2. **Contact a Product Management team member** to create an issue on your behalf\n3. **Review the README.md** and **CONTRIBUTING.md** for more details on contribution guidelines\n\nWe value your input and encourage you to participate by commenting on existing issues!\n\n---\n*This issue was automatically closed by the Issue Creation Policy enforcement workflow. If you believe this was done in error, please contact a repository administrator.*'
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed',
              state_reason: 'not_planned'
            });
